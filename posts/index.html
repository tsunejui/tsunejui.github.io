<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Posts - Rex&#39;s Notes 技術筆記 </title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="alternate" type="application/rss+xml" href="/posts/index.xml" title="Rex's Notes 技術筆記 ">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Rex&#39;s Notes 技術筆記 " rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Rex&#39;s Notes 技術筆記 </div>
					
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/posts/aboutme/">
				
				<span class="menu__text">About Me</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main list" role="main">
	<header class="main__header">
		<h1 class="main__title">Posts</h1>
	</header><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/container-mnt/" rel="bookmark">
			Container Note - Mount Namespace
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		使用環境 Rocky Linux 8.7
環境描述 維護 kubernetes 時，常常需要透過一些 CLI tool 維護 container，如果 image 本身不提供這些 tool，就會比較麻煩，這時候我們可以透過 kubectl cp 將我們需要維護的 CLI tool 複製到 container 內，但在官方的說明內有指出，使用 kubectl cp 會需要容器內有安裝 tar 指令，否則會失敗:
https://kubernetes.io/docs/reference/kubectl/cheatsheet/
我以 simple-spring-boot-app 這個專案為例，他的 base image 是 google 的 distroless，在這個 image 內，除了 java 外，並沒有其他的 command，這時候執行 kubectl cp，就會發生錯誤:
simple-spring-boot-app: https://github.com/tsunejui/simple-spring-boot-app
distroless: https://github.com/GoogleContainerTools/distroless
這時候，我們可能需要到 node 上，透過 container 的管理工具所提供的方法 (cp 指令)，將檔案複製到 container 內，一些工具如下:
Docker: docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|- Podman: podman cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|- cri-tools: crictl cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|- nerdctl: nerdctl cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|- 如果 node 上 container 的管理工具並沒有提供 cp 的功能，或者沒有網路安裝 container 的管理工具時，我們也找到該 process (也就是 container) 所使用 mnt namespace，並查看 / 的 mount point，直接將 CLI tool 放置於指定的目錄即可。
	</div>
</article><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/aws-security-token-service-example/" rel="bookmark">
			AWS Security Token Service (STS) Example
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		環境描述 最近公司需要評估 AWS ROSA 在客戶端導入的可行性，因此需要研究其行為，根據 ROSA 的文件，建立 ROSA 的方式可以分成 with STS 及 without STS，由於之前沒有使用過 AWS STS ，此篇文章作為 STS API 的基本測試步驟：
基本介紹 根據 AWS 官方介紹，AWS STS API 提供了 trusted users 取得 Temporary security credentials 的方法。在 AWS ROSA 上可以帶來一些好處：
測試步驟 (請先設定好 ~/.aws/credentials) 建立 User Alice aws iam create-user --user-name Alice 建立 Example Policy 編輯 iam policy 檔案: vi example-policy.json
{ &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Sid&#34;: &#34;VisualEditor0&#34;, &#34;Effect&#34;: &#34;Allow&#34;, &#34;Action&#34;: [ &#34;s3:ListStorageLensConfigurations&#34;, &#34;s3:ListAccessPointsForObjectLambda&#34;, &#34;s3:ListBucketMultipartUploads&#34;, &#34;s3:ListAllMyBuckets&#34;, &#34;s3:ListAccessPoints&#34;, &#34;s3:ListJobs&#34;, &#34;s3:ListBucketVersions&#34;, &#34;s3:ListBucket&#34;, &#34;s3:ListMultiRegionAccessPoints&#34;, &#34;s3:ListMultipartUploadParts&#34; ], &#34;Resource&#34;: &#34;*&#34; } ] } 新增 iam policy:
	</div>
</article><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/openshift-monitoring-prometheus-scale-down/" rel="bookmark">
			Scale Down the Prometheus on Openshift Monitoring
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		環境描述 客戶希望可以修改 Openshift 4.12 上 Prometheus 的 Replicas 數量為 0，希望我可以研究。
研究結果 目前 Openshift 4.12 沒有提供修改 Prometheus 數量的方法。 原本以為修改 Prometheus CRD 就可以更改 Replicas 的數量，但是修改後過沒多久就會被 Operator 改回來。以下是我找到的資料:
曾經在3.11可以調整replicas的設定，但後來消失了:
https://github.com/openshift/cluster-monitoring-operator/pull/330/commits/53453691c9d47f5c621a9d538aba12431541a2c8
我在 cluster-monitoring-operator 的設定上也沒找到參數可以調整，測試 replicas 也無法:
https://github.com/openshift/cluster-monitoring-operator/blob/master/Documentation/api.md#prometheusk8sconfig
目前我找到這個 issue，在 2020 年 8 月還不支援
https://github.com/openshift/cluster-monitoring-operator/issues/896
解決方法 現在這是我看過最暴力的做法，先透過修改 clusterversion/version ，將 openshift-monitoring 設定為 unmanaged，之後再 scale down 所有 deployment ，親測有效，但很暴力:
https://gist.github.com/waynedovey/cbf23d0a9c798c8de68b5f2043ba945b
oc patch clusterversion/version --type=&#39;merge&#39; -p &#34;$(cat &lt;&lt;- EOF spec: overrides: - group: apps/v1 kind: Deployment name: cluster-monitoring-operator namespace: openshift-monitoring unmanaged: true EOF )&#34; oc patch prometheus/k8s -n openshift-monitoring --type=&#39;merge&#39; -p &#34;$(cat &lt;&lt;- EOF spec: replicas: 0 EOF )&#34; oc patch alertmanagers/main -n openshift-monitoring --type=&#39;merge&#39; -p &#34;$(cat &lt;&lt;- EOF spec: replicas: 0 EOF )&#34; oc scale --replicas=0 deploy/cluster-monitoring-operator -n openshift-monitoring oc scale --replicas=0 deployment.
	</div>
</article><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/f5-vip-setting/" rel="bookmark">
			F5 VIP Setting
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		環境描述 客戶環境需要在 F5 設定 VIP，並分配流量到不同的主機，我需要在公司 Lab 上模擬，由於對 F5 的操作不熟悉，因此撰寫此篇文章作為紀錄 VIP 設定方法。
請注意，此篇文章是簡易的設定紀錄，我並非 F5 的專業人員，如果錯誤請見諒
F5 設定介面 到 Local Traffic / Pools / Pool List 頁面上新增 Pool:
設定 Name 及 Health Monitors 的方式 (下圖為新增後的編輯畫面):
到 Local Traffic / Virtual Servers / Virtual Servers List 頁面上新增 Virtual Server:
到 Properties 頁面上設定 General Properties 及憑證相關資料 (下圖為新增後的編輯畫面):
到 Resource 頁面上設定 Load Balancing (下圖為新增後的編輯畫面):
結果 設定完成後便立即生效，在 Local Traffic / Pools : Pool List / &lt;pool-name&gt; 上可以看到 Pool 內的 members 狀況:
	</div>
</article><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/openshift-gitops-dex-expiration-time/" rel="bookmark">
			Dex Expiration Time on Openshift Gitops
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		ArgoCD 認證機制:
修改流程:
環境描述 近期由於客戶需要導入 ArgoCD 管理 CRDs，因此在客戶的 Openshift 4.x 上安裝 GitOps Operator。安裝後發現了一個問題，ArgoCD 的 Web 介面需要約 24 小時後才會自動登出，客戶希望調整登出時間。
從上圖可得知，ArgoCD 的 web 會再登入後產生一把 token 並放到 cookie 內，名為 argocd.token，我們可以透過 jwt.io 解析這把 token，查看 expiration date:
在沒有做任何設定的情況下，透過 Openshift 帳密使用 SSO 登入機制進入 ArgoCD 畫面，所產生的 token 過期時間應該是 24h 後，這是因為 ArgoCD 在 SSO 認證上是交給 Dex Server 控制，而 Dex Server 的預設過期時間是 24h：
可以從 ArgoCD 的 Security 文章查看 Dex Server 的說明:
尋找方法 ArgoCD Operator 會透過 Kind: ArgoCD 的 CRD ，名為 openshift-gitops，產生需要的 components，如 server、applicationSet、grafana&hellip;:
	</div>
</article><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/node-clock-not-synchronising/" rel="bookmark">
			NodeClockNotSynchronising alert troubleshooting in Openshift 4
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		事件經過 某日客戶收到來自 OCP 的 critical 告警，名稱為 NodeClockNotSynchronising，請我們調查原因。
告警訊息 首先調查告警意義，至 openshoft-monitoring Project 下尋找名為 prometheus-k8s-rulefiles-0 的 ConfigMap，便可看到以下內容
https://github.com/openshift/runbooks/blob/master/alerts/cluster-monitoring-operator/NodeClockNotSynchronising.md
- alert: NodeClockNotSynchronising annotations: description: Clock on {{ $labels.instance }} is not synchronising. Ensure NTP is configured on this host. runbook_url: https://github.com/openshift/runbooks/blob/master/alerts/cluster-monitoring-operator/NodeClockNotSynchronising.md summary: Clock not synchronising. expr: | min_over_time(node_timex_sync_status{job=&#34;node-exporter&#34;}[5m]) == 0 and node_timex_maxerror_seconds{job=&#34;node-exporter&#34;} &gt;= 16 for: 10m labels: severity: critical 根據官方文件，我們可以得知以下訊息:
The NodeClockNotSynchronising alert triggers when a node is affected by issues with the NTP server for that node.
	</div>
</article><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/rhel-automation-platform-install/" rel="bookmark">
			RHEL Ansible Automation Platform (AAP) Installation
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		環境準備 Linux 的版本為 Red Hat Enterprise Linux 9.1 (Plow):
下載 tar 檔案 下載 Red Hat Ansible Automation Platform (v. 2.4 for RHEL 9 for x86_64): 至 https://access.redhat.com/downloads/content/480 下載 Ansible Automation Platform 2.4 Setup Bundle
解壓縮 tar xvzf ansible-automation-platform-setup-&lt;latest-version&gt;.tar.gz 安裝 Red Hat Ansible Automation Platform subscription 取得token 至 https://access.redhat.com/management/api 產生 Token
在 Redhat 上使用 subscription-manager register 註冊機器 你也可以透過 subscription-manager register --username &lt;username&gt; --password &lt;password&gt; --auto-attach 註冊機器
subscription-manager register --token &lt;token&gt; --insecure 獲得 Subscription 的 pool_id subscription-manager list --available --all | grep &#34;Ansible Automation Platform&#34; -B 3 -A 6 安裝 Subscription subscription-manager attach --pool=2c94e43f88fcee5b0189010269427636 驗證是否成功 subscription-manager list --consumed 建立 Ansible Automation Platform Database 如果需要自建 AAP 的 Database 則需執行此步驟，不需要請略過。
	</div>
</article><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/awx-install/" rel="bookmark">
			AWX Installation (Container)
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		利用 dokcer 安裝 AWX
使用環境 Rocky Linux 8.7
安裝步驟 關閉 SELinux 建議暫時關閉 SELinux 避免安裝中出錯:
setenforce 0 安裝 docker https://docs.docker.com/engine/install/centos/
安裝 yum-utils:
yum install -y yum-utils 加入 repository:
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo 安裝 docker
yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin 啟動 docker
systemctl start docker 下載 AWX 17.1.0 安裝 git:
dnf install -y git Starting in version 18.0, the AWX Operator is the preferred way to install AWX.
https://github.com/ansible/awx/blob/devel/INSTALL.md
git clone -b 17.
	</div>
</article><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/samba-install/" rel="bookmark">
			Samba 安裝
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		使用環境 Rocky Linux 8.7
安裝步驟 透過 dnf 安裝 samba:
dnf install samba 設定 systemd 開機自動啟動:
systemctl enable smb.service 開啟防火牆
firewall-cmd --permanent --add-service=samba &amp;&amp; firewall-cmd --reload 設定 samba 新增Linux User: rex
useradd rex 新增 samba 帳號: rex
smbpasswd -a rex 新增目錄 /mnt/shared 並指派 owner 為 rex:
mkdir /mnt/shared &amp;&amp; chown rex -R /mnt/shared/ 編輯 vi /etc/samba/smb.conf, 並且加入以下內容:
設定參數請參考: https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html
... [cnssmb] comment = CNS Samba Directory path = /mnt/shared public = yes create mask = 0777 directory mask = 0777 browseable = yes writeable = yes read only = no 設定 SELinux:
	</div>
</article><article class="list__item post">
	
	<header class="list__header">
		<h2 class="list__title post__title">
			<a href="/posts/kafka-kraft-install/" rel="bookmark">
			Kafka 安裝 - Kraft Mode
			</a>
		</h2>
		
	</header>
	<div class="content list__excerpt post__content clearfix">
		事前準備 Preparation 準備 3 台 node:
os name ip Rocky Linux 8.8 cns-kafka-0 192.168.50.170 Rocky Linux 8.8 cns-kafka-1 192.168.50.171 Rocky Linux 8.8 cns-kafka-2 192.168.50.172 安裝步驟 設定 hosts (在每個 Node 上執行) 透過以下指令設定 /etc/hosts:
cat &lt;&lt; EOF &gt;&gt; /etc/hosts 192.168.50.170 cns-kafka-0 192.168.50.171 cns-kafka-1 192.168.50.172 cns-kafka-2 EOF 安裝 OpenJDK 11 (在每個 Node 上執行) To use Corretto RPM repositories with the yum package manager (such as Amazon Linux AMI), import the Corretto public key and then add the repository to the system list.
	</div>
</article>
</main>

<div class="pagination">
	<span class="pagination__item pagination__item--current">1/3</span>
	<a class="pagination__item pagination__item--next btn" href="/posts/page/2/">»</a>
</div>

			</div>
			
<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH…" value="" name="q" aria-label="SEARCH…">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="https://tsunejui.github.io/">
	</form>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/container-mnt/">Container Note - Mount Namespace</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/aws-security-token-service-example/">AWS Security Token Service (STS) Example</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/openshift-monitoring-prometheus-scale-down/">Scale Down the Prometheus on Openshift Monitoring</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/f5-vip-setting/">F5 VIP Setting</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/openshift-gitops-dex-expiration-time/">Dex Expiration Time on Openshift Gitops</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/node-clock-not-synchronising/">NodeClockNotSynchronising alert troubleshooting in Openshift 4</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/rhel-automation-platform-install/">RHEL Ansible Automation Platform (AAP) Installation</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/awx-install/">AWX Installation (Container)</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/samba-install/">Samba 安裝</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/kafka-kraft-install/">Kafka 安裝 - Kraft Mode</a></li>
		</ul>
	</div>
</div>
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item">
				<a class="widget__link" href="/categories/aws/">AWS</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/container/">Container</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/devops/">Devops</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/f5/">F5</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/istio/">Istio</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/k8s/">K8S</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/kafka/">Kafka</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/linux/">Linux</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/openshift/">Openshift</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/profile/">Profile</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/prometheus/">Prometheus</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/sre/">SRE</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/debug/" title="Debug">Debug</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/note/" title="Note">Note</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/tip/" title="Tip">Tip</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 Rex Wu.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>
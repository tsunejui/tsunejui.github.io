<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Kubernetes 安裝筆記 - Rex&#39;s Notes 技術筆記 </title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Rex&#39;s Notes 技術筆記 " rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Rex&#39;s Notes 技術筆記 </div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kubernetes 安裝筆記</h1>
			
		</header>
		<div class="content post__content clearfix">
			<h2 id="安裝-kubernetes">安裝 Kubernetes</h2>
<h3 id="事前準備-preparation">事前準備 Preparation</h3>
<p><strong>Before you begin</strong></p>
<blockquote>
<p>Rocky Linux ISO 載點: <a href="https://rockylinux.org/">link</a></p>
<p>Kubernetes 安裝建議高於 2 core CPU 及 2 GB or more RAM: <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">link</a></p>
</blockquote>
<ul>
<li>準備 5 台 node, OS 選擇 <code>Rocky Linux 8</code></li>
<li>每台 node 需要 4 core CPU &amp; 8 GB memory (非必要)</li>
<li>6 組 IP (node * 5 + VIP * 1)</li>
</ul>
<p><strong>Kubernetes Interface</strong></p>
<table>
<thead>
<tr>
<th>interface</th>
<th>service</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<td>CRI</td>
<td>containerd</td>
<td>1.6.19</td>
</tr>
<tr>
<td>CNI</td>
<td>calico</td>
<td>3.25.0</td>
</tr>
</tbody>
</table>
<p><strong>nodes</strong></p>
<blockquote>
<p>建議登入每台主機，並使用 <code>hostnamectl set-hostname xxx</code> 修改 hostname</p>
<p>選擇 192.168.50.125 作為 VIP</p>
</blockquote>
<table>
<thead>
<tr>
<th>node</th>
<th>ip</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>master0</td>
<td>192.168.50.120</td>
<td>cns-k8s-master0</td>
</tr>
<tr>
<td>master1</td>
<td>192.168.50.121</td>
<td>cns-k8s-master1</td>
</tr>
<tr>
<td>master2</td>
<td>192.168.50.122</td>
<td>cns-k8s-master2</td>
</tr>
<tr>
<td>worker0</td>
<td>192.168.50.123</td>
<td>cns-k8s-worker0</td>
</tr>
<tr>
<td>worker1</td>
<td>192.168.50.124</td>
<td>cns-k8s-worker1</td>
</tr>
</tbody>
</table>
<h3 id="設定-etchosts">設定 /etc/hosts</h3>
<pre tabindex="0"><code>vi /etc/hosts

192.168.50.120 cns-k8s-master0
192.168.50.121 cns-k8s-master1
192.168.50.122 cns-k8s-master2
192.168.50.123 cns-k8s-worker0
192.168.50.124 cns-k8s-worker1
</code></pre><h3 id="關閉-firewall">關閉 firewall</h3>
<blockquote>
<p>calico 官網建議關閉 firewalld，因為他們都是透過 iptables 實現 nat 轉發，可能會有互相干擾的風險: <a href="https://docs.tigera.io/calico/3.25/getting-started/kubernetes/requirements">link</a></p>
<p>Kubernetes 預設會使用的 Ports 及 Protocols: <a href="https://kubernetes.io/docs/reference/networking/ports-and-protocols/">link</a></p>
<p>Calico 預設會使用的 Ports 及 Protocols: <a href="https://docs.tigera.io/calico/3.25/getting-started/kubernetes/requirements">link</a></p>
</blockquote>
<pre tabindex="0"><code>systemctl disable firewalld &amp;&amp; systemctl stop firewalld
</code></pre><h3 id="在每一台-node-上運行">在每一台 node 上運行</h3>
<p><strong>關閉 swap</strong></p>
<pre tabindex="0"><code>swapoff -a &amp;&amp; sed -i &#39;/ swap / s/^\(.*\)$/#\1/g&#39; /etc/fstab
</code></pre><p><strong>關閉 SELinux</strong></p>
<pre tabindex="0"><code>sudo setenforce 0 &amp;&amp; sudo sed -i &#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39; /etc/selinux/config
</code></pre><p><strong>安裝 CRI (以 containerd 1.6.19 為例)</strong></p>
<blockquote>
<p><a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">https://github.com/containerd/containerd/blob/main/docs/getting-started.md</a></p>
</blockquote>
<p><strong>下載 <code>.tar.gz</code> 檔案</strong></p>
<pre tabindex="0"><code>curl -OL https://github.com/containerd/containerd/releases/download/v1.6.19/containerd-1.6.19-linux-amd64.tar.gz
</code></pre><p><strong>解壓縮</strong></p>
<pre tabindex="0"><code>tar Cxzvf /usr/local containerd-1.6.19-linux-amd64.tar.gz
</code></pre><p><strong>設定 cgroup driver 為 systemd</strong></p>
<blockquote>
<p><a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">https://kubernetes.io/docs/setup/production-environment/container-runtimes/</a></p>
</blockquote>
<p>生產 config 檔案</p>
<pre tabindex="0"><code>mkdir /etc/containerd &amp;&amp; containerd config default &gt; /etc/containerd/config.toml
</code></pre><p>為了使用 <code>Systemd</code> 作為 cgroup driver，需要修改 config 檔案 <code>/etc/containerd/config.toml</code>, 將 <code>SystemdCgroup</code> 改為 <code>true</code></p>
<blockquote>
<p>Why kubernetes choose systemd not cgroupfs? <a href="https://www.sobyte.net/post/2022-07/k8s-cgroupfs-or-syste/">https://www.sobyte.net/post/2022-07/k8s-cgroupfs-or-syste/</a></p>
</blockquote>
<pre tabindex="0"><code>vi /etc/containerd/config.toml

[plugins.&#34;io.containerd.grpc.v1.cri&#34;.containerd.runtimes.runc.options]
    BinaryName = &#34;&#34;
    CriuImagePath = &#34;&#34;
    CriuPath = &#34;&#34;
    CriuWorkPath = &#34;&#34;
    IoGid = 0
    IoUid = 0
    NoNewKeyring = false
    NoPivotRoot = false
    Root = &#34;&#34;
    ShimCgroup = &#34;&#34;
    SystemdCgroup = true
</code></pre><p>下載 service 檔案</p>
<blockquote>
<p>由於 containerd 預設的 config path 是 <code>/etc/containerd/config.toml</code> ，所以不需要改 service 檔案，可以透過 <code>containerd --help</code> 得知。</p>
</blockquote>
<pre tabindex="0"><code>curl -o /usr/lib/systemd/system/containerd.service https://raw.githubusercontent.com/containerd/containerd/main/containerd.service
</code></pre><p>開機啟動 containerd</p>
<pre tabindex="0"><code>systemctl daemon-reload &amp;&amp; systemctl enable --now containerd
</code></pre><p><strong>安裝 runc (以 v1.1.4 為例)</strong></p>
<p>下載 runc.amd64</p>
<pre tabindex="0"><code>curl -OL https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64
</code></pre><p>安裝 runc</p>
<pre tabindex="0"><code>install -m 755 runc.amd64 /usr/local/sbin/runc
</code></pre><p><strong>安裝 CNI Plugin</strong></p>
<p>下載壓縮檔</p>
<pre tabindex="0"><code>curl -OL https://github.com/containernetworking/plugins/releases/download/v1.2.0/cni-plugins-linux-amd64-v1.2.0.tgz
</code></pre><p>解壓縮檔案</p>
<pre tabindex="0"><code>mkdir -p /opt/cni/bin &amp;&amp; tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.2.0.tgz
</code></pre><p><strong>載入 Kubernetes 所需的 modules</strong></p>
<pre tabindex="0"><code>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay &amp;&amp; sudo modprobe br_netfilter

cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sudo sysctl --system
</code></pre><p><strong>啟動 containerd</strong></p>
<pre tabindex="0"><code>systemctl restart containerd
</code></pre><p><strong>安裝ipvsadm</strong></p>
<pre tabindex="0"><code>dnf -y install ipvsadm
</code></pre><p><strong>安裝 kubelet kubeadm kubectl</strong></p>
<p>新增 repo 位置</p>
<pre tabindex="0"><code>cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
enabled=1
gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF
</code></pre><p>安裝工具並啟動 kubelet</p>
<blockquote>
<p>安裝 <code>iproute-tc</code> 是因為使用 kubeadm join node 時會發生 <code>tc not found</code> 問題: <a href="https://stackoverflow.com/questions/59653331/kubernetes-centos-8-tc-command-missing-impact">link</a></p>
</blockquote>
<pre tabindex="0"><code>sudo yum install -y kubelet kubeadm kubectl iproute-tc --disableexcludes=kubernetes &amp;&amp; sudo systemctl enable --now kubelet
</code></pre><h3 id="在-master-node-上設定">在 master node 上設定</h3>
<blockquote>
<p>使用 haproxy 及 keepalived 實現 high availability，可以建立 manifest 到 <code>/etc/kubernetes</code> 作為 static pod 啟動。</p>
</blockquote>
<p><strong>haproxy 設定</strong></p>
<blockquote>
<p>haproxy.cfg refs: <a href="/kubernetes/haproxy.cfg">link</a></p>
</blockquote>
<pre tabindex="0"><code>mkdir /etc/haproxy &amp;&amp; vi /etc/haproxy/haproxy.cfg
</code></pre><p><strong>建立 manifest</strong></p>
<blockquote>
<p>haproxy.yaml refs: <a href="/kubernetes/haproxy.yaml">link</a></p>
<p>keepalived.yaml refs: <a href="/kubernetes/keepalived.yaml">link</a></p>
</blockquote>
<pre tabindex="0"><code>vi /etc/kubernetes/manifests/haproxy.yaml

vi /etc/kubernetes/manifests/keepalived.yaml
</code></pre><h3 id="在-master-node-0-上設定">在 master node 0 上設定</h3>
<p><strong>修改 Kubeadm Config 檔案</strong></p>
<p>使用 <code>kubeadm config print init-defaults</code> 指令匯出設定 YAML 檔案。</p>
<pre tabindex="0"><code>kubeadm config print init-defaults &gt; kubeadm-config.yaml
</code></pre><p>修改 <code>kubeadm-config.yaml</code> 檔案:</p>
<blockquote>
<p>kubeadm-config.yaml refs: <a href="/kubernetes/kubeadm-config.yaml">link</a></p>
<p>注意 <code>podSubnet</code> 及 <code>serviceSubnet</code> 最好不要與目前電腦的 private IP 相同網段，避免發生衝突。</p>
<p>kube-proxy 使用模式為 <code>ipvs</code></p>
<p>podSubnet: <code>10.244.0.0/16</code></p>
<p>serviceSubnet: <code>10.96.0.0/12</code></p>
</blockquote>
<pre tabindex="0"><code>vi kubeadm-config.yaml
</code></pre><p><strong>初始化 Kubernetes</strong></p>
<blockquote>
<p>初始化成功後，系統會提示將 <code>/etc/kubernetes/admin.conf</code> 複製到 <code>$HOME/.kube/config</code>，便可以使用 <code>kubectl get nodes</code> 查看狀況。</p>
</blockquote>
<pre tabindex="0"><code>kubeadm init --config=kubeadm-config.yaml
</code></pre><p><strong>安裝 Calico operator</strong></p>
<pre tabindex="0"><code>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/tigera-operator.yaml
</code></pre><p><strong>設定 Calico POD_CIDR</strong></p>
<p>下載 <code>calico.yaml</code>，修改 <code>spec.calicoNetwork.ipPools.cidr</code> 為 <code>10.244.0.0/16</code></p>
<pre tabindex="0"><code>curl -OL https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/custom-resources.yaml

vi custom-resources.yaml

kubectl apply -f custom-resources.yaml
</code></pre><p>檢查 calico 安裝進度:</p>
<pre tabindex="0"><code>watch kubectl get pods -n calico-system
</code></pre><p>安裝完成後，便可使用 kubernetes。</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/note/" rel="tag">Note</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 Rex Wu.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>